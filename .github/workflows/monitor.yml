name: Monitor Application Health

on:
  schedule:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check GitHub Pages
        id: gh-pages
        run: |
          URL="https://sarkisisraelyan.github.io/CalmBrew-"
          if curl -f -s "$URL" > /dev/null; then
            echo "status=online" >> $GITHUB_OUTPUT
            echo "‚úÖ GitHub Pages —Ä–∞–±–æ—Ç–∞–µ—Ç: $URL"
          else
            echo "status=offline" >> $GITHUB_OUTPUT
            echo "‚ùå GitHub Pages –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: $URL"
          fi
      
      - name: Check response time
        if: steps.gh-pages.outputs.status == 'online'
        run: |
          URL="https://sarkisisraelyan.github.io/CalmBrew-"
          RESPONSE_TIME=$(curl -w "%{time_total}" -s -o /dev/null "$URL")
          echo "‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${RESPONSE_TIME}s"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
          if (( $(echo "$RESPONSE_TIME > 5" | bc -l) )); then
            echo "‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ${RESPONSE_TIME}s"
            exit 1
          fi
      
      - name: Check bot status
        run: |
          BOT_USERNAME="CalmBrew_Bot"
          BOT_URL="https://t.me/$BOT_USERNAME"
          echo "ü§ñ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ—Ç–∞: $BOT_URL"
          echo "‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é"
      
      - name: Generate report
        run: |
          echo "## üìä –û—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è" >> report.md
          echo "" >> report.md
          echo "**–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏:** $(date)" >> report.md
          echo "**GitHub Pages:** ${{ steps.gh-pages.outputs.status }}" >> report.md
          echo "**–°—Ç–∞—Ç—É—Å:** ${{ job.status }}" >> report.md
          echo "" >> report.md
          echo "### üîó –°—Å—ã–ª–∫–∏:" >> report.md
          echo "- üåê –°–∞–π—Ç: https://sarkisisraelyan.github.io/CalmBrew-" >> report.md
          echo "- ü§ñ –ë–æ—Ç: https://t.me/CalmBrew_Bot" >> report.md
          echo "- üìÅ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/Sarkisyan444/CalmBrew-" >> report.md
      
      - name: Upload report
        uses: actions/upload-artifact@v3
        with:
          name: health-report
          path: report.md

  notify:
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    steps:
      - name: Download report
        uses: actions/download-artifact@v3
        with:
          name: health-report
      
      - name: Show status
        run: |
          if [ -f report.md ]; then
            echo "üìã –û—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏:"
            cat report.md
          fi
          
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã!"
          fi
